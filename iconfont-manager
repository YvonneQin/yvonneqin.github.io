#!/bin/bash

# iconfont ç®¡ç†å™¨
# ä½¿ç”¨æ–¹æ³•: ./iconfont-manager [å‘½ä»¤] [å‚æ•°]

show_help() {
    echo "ğŸ¨ iconfont ç®¡ç†å™¨"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  ./iconfont-manager update [æ–°é“¾æ¥]     - æ›´æ–°æ‰€æœ‰iconfonté“¾æ¥"
    echo "  ./iconfont-manager status              - æŸ¥çœ‹å½“å‰çŠ¶æ€"
    echo "  ./iconfont-manager backup              - åˆ›å»ºå¤‡ä»½"
    echo "  ./iconfont-manager restore             - æ¢å¤å¤‡ä»½"
    echo "  ./iconfont-manager help                - æ˜¾ç¤ºå¸®åŠ©"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  ./iconfont-manager update https://at.alicdn.com/t/c/font_4545731_new.css"
    echo "  ./iconfont-manager status"
}

update_iconfont() {
    local new_url="$1"
    
    if [ -z "$new_url" ]; then
        echo "âŒ è¯·æä¾›æ–°çš„iconfonté“¾æ¥"
        echo "ä½¿ç”¨æ–¹æ³•: ./iconfont-manager update [æ–°é“¾æ¥]"
        exit 1
    fi
    
    echo "ğŸ”„ æ­£åœ¨æ›´æ–°iconfonté“¾æ¥åˆ°: $new_url"
    
    # åˆ›å»ºå¤‡ä»½
    echo "ğŸ’¾ åˆ›å»ºå¤‡ä»½..."
    find . -name "*.html" -type f -exec cp {} {}.backup \;
    
    # æ›´æ–°æ‰€æœ‰HTMLæ–‡ä»¶
    echo "ğŸ“ æ›´æ–°HTMLæ–‡ä»¶..."
    find . -name "*.html" -type f -exec sed -i '' "s|https://at\.alicdn\.com/t/c/font_[^.]*\.css|$new_url|g" {} \;
    
    # æ›´æ–°é…ç½®æ–‡ä»¶
    if [ -f "iconfont-config.json" ]; then
        sed -i '' "s|\"url\": \"[^\"]*\"|\"url\": \"$new_url\"|g" iconfont-config.json
        echo "âœ… å·²æ›´æ–° iconfont-config.json"
    fi
    
    if [ -f "js/config.js" ]; then
        sed -i '' "s|primary: '[^']*'|primary: '$new_url'|g" js/config.js
        echo "âœ… å·²æ›´æ–° js/config.js"
    fi
    
    # ç»Ÿè®¡æ›´æ–°çš„æ–‡ä»¶
    local updated_count=$(find . -name "*.html" -type f -exec grep -l "at\.alicdn\.com" {} \; | wc -l)
    
    echo "âœ… æ›´æ–°å®Œæˆï¼"
    echo "ğŸ“Š å…±æ›´æ–°äº† $updated_count ä¸ªæ–‡ä»¶"
    echo "ğŸ”— æ–°é“¾æ¥: $new_url"
    echo "ğŸ’¾ å¤‡ä»½æ–‡ä»¶å·²ä¿å­˜ä¸º .backup æ‰©å±•å"
}

show_status() {
    echo "ğŸ“Š iconfont çŠ¶æ€æŠ¥å‘Š"
    echo ""
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    if [ -f "iconfont-config.json" ]; then
        local config_url=$(grep -o '"url": "[^"]*"' iconfont-config.json | cut -d'"' -f4)
        echo "ğŸ“„ iconfont-config.json: $config_url"
    fi
    
    if [ -f "js/config.js" ]; then
        local js_url=$(grep -o "primary: '[^']*'" js/config.js | cut -d"'" -f2)
        echo "ğŸ“„ js/config.js: $js_url"
    fi
    
    # ç»Ÿè®¡HTMLæ–‡ä»¶ä¸­çš„é“¾æ¥
    echo ""
    echo "ğŸ“ HTMLæ–‡ä»¶ä¸­çš„iconfonté“¾æ¥:"
    find . -name "*.html" -type f -exec grep -l "at\.alicdn\.com" {} \; | while read file; do
        local url=$(grep -o "https://at\.alicdn\.com/t/c/font_[^.]*\.css" "$file" | head -1)
        echo "  $file: $url"
    done
    
    # ç»Ÿè®¡å¤‡ä»½æ–‡ä»¶
    local backup_count=$(find . -name "*.html.backup" -type f | wc -l)
    echo ""
    echo "ğŸ’¾ å¤‡ä»½æ–‡ä»¶æ•°é‡: $backup_count"
}

create_backup() {
    echo "ğŸ’¾ åˆ›å»ºå¤‡ä»½..."
    find . -name "*.html" -type f -exec cp {} {}.backup \;
    echo "âœ… å¤‡ä»½å®Œæˆï¼"
}

restore_backup() {
    echo "ğŸ”„ æ¢å¤å¤‡ä»½..."
    find . -name "*.html.backup" -type f -exec sh -c 'mv "$1" "${1%.backup}"' _ {} \;
    echo "âœ… æ¢å¤å®Œæˆï¼"
}

# ä¸»ç¨‹åº
case "$1" in
    "update")
        update_iconfont "$2"
        ;;
    "status")
        show_status
        ;;
    "backup")
        create_backup
        ;;
    "restore")
        restore_backup
        ;;
    "help"|"--help"|"-h"|"")
        show_help
        ;;
    *)
        echo "âŒ æœªçŸ¥å‘½ä»¤: $1"
        show_help
        exit 1
        ;;
esac
